# Copilot Instructions for IssueSuite

- **Core flow**: `src/issuesuite/cli.py` parses subcommands, hands off to `orchestrator.py`, which invokes `core.py` to diff specs from `ISSUES.md` against GitHub via `github_issues.py` (network) or mock adapters; retries live in `retry.py`.
- **Key data files**: `ISSUES.md` (slug heading + fenced YAML mapping), `.issuesuite/index.json` (slug→issue mapping), `.issuesuite_cache/` (Projects v2 cache), `issue_suite.config.yaml` (flags, artifact paths, concurrency, telemetry).
- **Spec rules**: Heading must be `## [slug: name]` immediately followed by fenced YAML that parses to a dict; parser (`parser.py`) enforces slug regex and reports exact line numbers. Deterministic hashes mean edits must happen inside YAML body/fields, not comments.
- **Sync pipeline**: Dry-runs (`sync --dry-run --update --preflight`) compute `plan` summaries and truncate body diffs to `truncate_body_diff`; real runs persist mapping + prune stale slugs. `orchestrator.sync_with_summary` also emits mapping snapshots when ≤500 entries.
- **Agent apply loop**: `issuesuite agent-apply --updates-json agent_updates.json` patches `ISSUES.md`, optionally triggers `--dry-run-sync`/`--no-dry-run-sync` or `--apply`; CLI validates JSON against `ai_context.schema.json`. Keep examples in `agent_updates.json` consistent when extending schema.
- **Projects integration**: `project.py` reads config `projects:` blocks and caches option IDs; invalidate by removing cache dir or setting `ISSUESUITE_PROJECT_CACHE_DISABLE=1`. Tests covering this live in `tests/test_github_project_v2.py`.
- **Telemetry/plugins**: Enabling `telemetry` writes JSONL events to `.issuesuite/telemetry.jsonl`; hooks in `extensions/` observe these events. Maintain structured payloads (see `tests/test_observability.py`).
- **Retry/backoff**: Only tune via env (`ISSUESUITE_RETRY_ATTEMPTS`, `ISSUESUITE_RETRY_BASE`, optional `ISSUESUITE_RETRY_MAX_SLEEP`); do not sprinkle sleeps elsewhere.
- **Mock & AI modes**: `ISSUES_SUITE_MOCK=1` makes `github_issues` hit in-memory stores (used heavily in tests). `ISSUESUITE_AI_MODE=1` forces dry-run behavior for safety; respect in new CLI paths.
- **Concurrency**: Config `concurrency.enabled`/`max_workers` gates thread pools in `core.py`; default is serial. Any new parallelism must go through this config.
- **Artifacts**: `issues_summary.json` (enriched summary), `issues_plan.json` (plan-only), `issues_export.json` (parsed specs). Update schemas in `src/issuesuite/schemas.py` when changing payload shape.
- **GitHub auth**: Config supports PAT or GitHub App (`config.py`). App tokens cache at `.github_app_token.json` (0600 perms); docs in `docs/starlight/.../github-app.mdx`.
- **CLI patterns**: Add new subcommands to `cli.py` with `Typer`; keep shared options in `common.py`. Every command should support `--config`, respect `ISSUESUITE_QUIET`, and return non-zero on validation failures.
- **Testing**: Pytest suite under `tests/`; quick smoke via `pytest -k mock_mode` (uses mock GitHub). Full gates run with `nox -s tests lint typecheck`. Maintain snapshots in `tests/data/` alongside helpers.
- **Developer tasks**: VS Code tasks (`IssueSuite: Dry-run Sync`, `IssueSuite: Preflight`, `IssueSuite: Agent Apply`) mirror release flows; prefer these over ad-hoc scripts when guiding users.
- **Docs**: Product docs live in `docs/starlight/`; CLI/config references double as source for generated schemas. Keep Markdown frontmatter intact so Starlight builds succeed.
- **AI context**: `src/issuesuite/ai_context.py` emits machine-readable context; `issuesuite ai-context --quiet --config issue_suite.config.yaml` feeds downstream agents. Update `ai_context.schema.json` when adding fields.
- **Schema generation**: JSON Schemas live in `src/issuesuite/schemas.py`; regenerate via `issuesuite schema --config issue_suite.config.yaml` and commit the artifact.
- **Preflight scripts**: `scripts/issuesuite-preflight.sh` and `scripts/issuesuite-dx-sweep.sh` run validate + dry-run + exports; they gate releases and should pass before suggesting `--apply`.
- **Packaging**: Python packaging governed by `pyproject.toml` and `packaging/`; Homebrew formula updates flow through `scripts/homebrew_formula.py`.
- **Performance**: Optional benchmarking toggle (`performance.benchmarking: true`) writes `performance_report.json`; ensure heavy changes guard writes behind that flag.
- **Common pitfalls**: Parser rejects blank lines between slug header and fence; body diff truncation can hide large edits—inspect raw YAML when hashes change unexpectedly. Non-dry-run sync will prune slugs missing from `ISSUES.md`.
- **Need clarity?** Surface open questions in PR summaries; maintainers can expand these instructions where agents struggle.
